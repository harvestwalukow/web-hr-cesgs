{% extends 'layouts/base.html' %}
{% load static %}
{% block title %} Laporan Jatah Cuti {% endblock title %}

{% block content %}
<div class="header bg-primary pb-6">
  <div class="container-fluid">
    <div class="header-body">
      <div class="row align-items-center py-4">
        <div class="col-12">
          <h2 class="text-white">Laporan Jatah Cuti Karyawan</h2>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid mt--6">
  <style>
    /* Sticky Identity Columns */
    #tabel-jatah-cuti th:nth-child(1),
    #tabel-jatah-cuti td:nth-child(1) {
      position: sticky;
      left: 0;
      z-index: 5;
      background-color: #f6f9fc;
      width: 50px;
      min-width: 50px;
      max-width: 50px;
      border-right: 1px solid #dee2e6;
    }
    
    #tabel-jatah-cuti th:nth-child(2),
    #tabel-jatah-cuti td:nth-child(2) {
      position: sticky;
      left: 50px; /* Lebar kolom No */
      z-index: 5;
      background-color: #f6f9fc;
      min-width: 200px;
      border-right: 1px solid #dee2e6;
    }

    /* Warna background body untuk sticky columns */
    #tabel-jatah-cuti tbody td:nth-child(1),
    #tabel-jatah-cuti tbody td:nth-child(2) {
      background-color: #fff;
    }

    /* Fix z-index header agar di atas body saat scroll vertical */
    #tabel-jatah-cuti thead th:nth-child(1),
    #tabel-jatah-cuti thead th:nth-child(2) {
      z-index: 6;
    }
  </style>

  <!-- Notifikasi Cuti Expired -->
  {% if cuti_expired %}
  <div id="expired-alert" class="alert alert-warning alert-dismissible fade show" role="alert">
    <h4 class="alert-heading">Peringatan Jatah Cuti Expired!</h4>
    <p>Beberapa jatah cuti telah expired (lebih dari 1 tahun tidak digunakan):</p>
    <ul>
      {% for item in cuti_expired %}
      <li>{{ item.karyawan }} - {{ item.bulan }} {{ item.tahun }}</li>
      {% endfor %}
    </ul>
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  {% endif %}

  <div class="card shadow">
    <div class="card-header">
      <h4 class="mb-0">Laporan Jatah Cuti Tahun {{ tahun }}</h4>
    </div>
    <div class="card-body">
      <!-- Filter -->
      <div class="row mb-4">
        <div class="col-md-8">
          <form method="get" class="form-inline">
            <div class="form-group mr-2">
              <label for="tahun" class="mr-2">Tahun:</label>
              <select name="tahun" id="tahun" class="form-control">
                {% for year in tahun_options %}
                <option value="{{ year }}" {% if year == tahun %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group mr-2">
              <label for="nama" class="mr-2">Nama:</label>
              <input type="text" name="nama" id="nama" class="form-control" value="{{ nama }}" placeholder="Cari nama karyawan...">
            </div>
            <button type="submit" class="btn btn-primary">Filter</button>
            <a href="{% url 'laporan_jatah_cuti' %}" class="btn btn-secondary ml-2">Reset</a>
          </form>
        </div>
        <div class="col-md-4 text-right">
          <div class="btn-group" role="group">
            <a href="{% url 'export_laporan_jatah_cuti_excel' %}?tahun={{ tahun }}&nama={{ nama }}" class="btn btn-success">
              <i class="fas fa-file-excel"></i> Export Excel
            </a>
          </div>
        </div>
      </div>

      <!-- Tabel Laporan -->
      <div class="table-responsive">
        <table class="table table-bordered table-hover" id="tabel-jatah-cuti">
          <thead class="thead-light">
            <tr>
              <th rowspan="2" class="align-middle text-center">No</th>
              <th rowspan="2" class="align-middle text-center">Nama Lengkap</th>
              {% for bulan in nama_bulan %}
              <th class="text-center">{{ bulan }}</th>
              {% endfor %}
              <th rowspan="2" class="align-middle text-center">Saldo Cuti</th>
            </tr>
          </thead>
          <tbody>
            {% for item in laporan_data %}
            <tr data-karyawan-id="{{ item.karyawan.id }}">
              <td class="text-center">{{ forloop.counter }}</td>
              <td>{{ item.karyawan.nama }}</td>
              {% for bulan in item.bulan_data %}
                <td class="text-center bulan-cell {% if not bulan.tersedia %}bg-light text-muted{% endif %}"
                    data-bulan="{{ forloop.counter }}" 
                    data-dipakai="{{ bulan.dipakai|yesno:'true,false' }}" 
                    data-keterangan="{{ bulan.keterangan }}" 
                    data-expired="{{ bulan.expired|yesno:'true,false' }}"
                    data-tersedia="{{ bulan.tersedia|yesno:'true,false' }}"
                    {% if not bulan.tersedia %}style="cursor: not-allowed;"{% endif %}>
                    
                    {% if not bulan.tersedia %}
                      <span class="badge badge-secondary" data-toggle="tooltip" title="Belum masuk kerja">N/A</span>
                    {% elif bulan.dipakai and "Cuti Tahunan" in bulan.keterangan %}
                      <span class="badge badge-success" data-toggle="tooltip" title="{{ bulan.keterangan }}">Cuti</span>
                    {% elif bulan.dipakai and "Hangus" in bulan.keterangan %}
                      <span class="badge badge-danger" data-toggle="tooltip" title="Hangus (Expired)">Expired</span>
                    {% elif bulan.expired %}
                      <span class="badge badge-danger" data-toggle="tooltip" title="Cuti Expired">Expired</span>
                    {% elif bulan.dipakai %}
                      <span class="badge badge-success" data-toggle="tooltip" title="{{ bulan.keterangan }}">Cuti</span>
                    {% else %}
                      <span class="badge badge-light">-</span>
                    {% endif %}
                </td>
              {% endfor %}
              <td class="text-center sisa-cuti">{{ item.sisa_cuti }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="15" class="text-center">Tidak ada data</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% include 'includes/footer.html' %}
</div>

<!-- Modal Edit Jatah Cuti -->
<div class="modal fade" id="modalEditJatahCuti" tabindex="-1" aria-labelledby="modalEditJatahCutiLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalEditJatahCutiLabel">Cuti Manual</h5>
        <button type="button" id="modalEditClose" class="close" data-dismiss="modal" data-bs-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="formEditJatahCuti">
          <input type="hidden" id="edit_karyawan_id" name="karyawan_id">
          <input type="hidden" id="edit_tahun" name="tahun" value="{{ tahun }}">
          <input type="hidden" id="edit_bulan" name="bulan">
          
          <div class="form-group">
            <label for="edit_nama_karyawan">Nama Karyawan:</label>
            <input type="text" class="form-control bg-light" id="edit_nama_karyawan" readonly>
          </div>
          
          <div class="form-group">
            <label for="edit_nama_bulan">Bulan:</label>
            <input type="text" class="form-control bg-light" id="edit_nama_bulan" readonly>
          </div>
          
          <div class="form-group mb-4">
            <label class="form-label mb-3">Status Cuti:</label>
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="edit_dipakai" name="dipakai">
              <label class="form-check-label" for="edit_dipakai">
                <strong>Cuti Dipakai</strong>
                <small class="text-muted d-block">Centang jika ingin menandai cuti pada bulan ini</small>
              </label>
            </div>
          </div>
          
          <!-- Field tambahan yang muncul ketika status dipakai dipilih -->
          <div id="detail_cuti_fields" class="d-none">
            <div class="form-group">
              <label for="edit_tanggal">Tanggal Cuti: <span class="text-danger">*</span></label>
              <input type="date" class="form-control" id="edit_tanggal" name="tanggal" required>
              <small class="form-text text-muted">Pilih satu tanggal dalam bulan yang dipilih</small>
            </div>
            
            <div class="form-group">
              <label for="edit_jenis_cuti">Jenis Cuti: <span class="text-danger">*</span></label>
              <select class="form-control" id="edit_jenis_cuti" name="jenis_cuti" required>
                <option value="">-- Pilih Jenis Cuti --</option>
                <option value="tahunan">Cuti Tahunan</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="edit_file_persetujuan">File Persetujuan:</label>
              <input type="file" class="form-control-file" id="edit_file_persetujuan" name="file_persetujuan" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
              <small class="form-text text-muted">Format yang diizinkan: PDF, DOC, DOCX, JPG, JPEG, PNG (Max: 5MB) - Opsional</small>
            </div>
          </div>
          
          <div class="form-group">
            <label for="edit_keterangan">Keterangan:</label>
            <textarea class="form-control" id="edit_keterangan" name="keterangan" rows="3"></textarea>
            <small class="form-text text-muted">Contoh: Cuti Tahunan, Keperluan Keluarga, dll.</small>
          </div>
          
          <div id="expired_warning" class="alert alert-danger d-none">
            <strong>Peringatan!</strong> Jatah cuti ini sudah expired (lebih dari 1 tahun tidak digunakan).
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary" id="btnSimpanJatahCuti">
          <span id="btnText">Simpan</span>
          <span id="btnSpinner" class="spinner-border spinner-border-sm d-none ml-2" role="status" aria-hidden="true"></span>
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock content %}


{% block javascripts %}
<script>
$(function () {
    // Inisialisasi tooltip
    $('[data-toggle="tooltip"]').tooltip();
    
    // CSRF token untuk AJAX
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    
    // Nama bulan untuk display
    const namaBulan = [
        'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
        'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
    ];
    
    // Event handler untuk klik sel bulan
    $('.bulan-cell').on('click', function() {
        // Cek apakah bulan tersedia
        const tersedia = $(this).data('tersedia');
        if (!tersedia) {
            alert('Bulan ini tidak dapat diedit karena karyawan belum masuk kerja pada periode tersebut.');
            return;
        }
        
        console.log('Sel bulan diklik!');
        const $row = $(this).closest('tr');
        const karyawanId = $row.data('karyawan-id');
        const namaKaryawan = $row.find('td:eq(1)').text();
        const bulanIndex = $(this).data('bulan');
        
        console.log('Data yang diambil:');
        console.log('- karyawanId:', karyawanId);
        console.log('- namaKaryawan:', namaKaryawan);
        console.log('- bulanIndex:', bulanIndex);
        
        // Isi data dasar form modal
        $('#edit_karyawan_id').val(karyawanId);
        $('#edit_nama_karyawan').val(namaKaryawan);
        $('#edit_bulan').val(bulanIndex);
        $('#edit_nama_bulan').val(namaBulan[bulanIndex-1]);
        
        // Reset form terlebih dahulu
        $('#edit_dipakai').prop('checked', false);
        $('#edit_keterangan').val('');
        $('#edit_tanggal').val('');
        $('#edit_jenis_cuti').val('');
        $('#edit_file_persetujuan').val('');
        $('#detail_cuti_fields').addClass('d-none');
        $('#expired_warning').addClass('d-none');
        
        console.log('Memulai AJAX request...');
        
        // Lakukan AJAX request untuk mendapatkan detail data
        $.ajax({
            url: '{% url "get_detail_jatah_cuti_ajax" %}',
            type: 'GET',
            data: {
                karyawan_id: karyawanId,
                tahun: $('#edit_tahun').val(),
                bulan: bulanIndex
            },
            success: function(response) {
                console.log('AJAX Response received:', response);
                if (response.status === 'success') {
                    const data = response.data;
                    console.log('Data from server:', data);
                    
                    // Isi form dengan data yang diterima
                    $('#edit_dipakai').prop('checked', data.dipakai);
                    $('#edit_keterangan').val(data.keterangan || '');
                    
                    console.log('Form filled - dipakai:', data.dipakai);
                    console.log('Form filled - keterangan:', data.keterangan);
                    
                    // Jika dipakai, isi field detail cuti
                    if (data.dipakai) {
                        console.log('Data is used, filling detail fields...');
                        console.log('tanggal:', data.tanggal);
                        console.log('jenis_cuti:', data.jenis_cuti);
                        
                        $('#edit_tanggal').val(data.tanggal || '');
                        $('#edit_jenis_cuti').val(data.jenis_cuti || '');
                        $('#detail_cuti_fields').removeClass('d-none');
                        $('#edit_keterangan').prop('disabled', false);
                    } else {
                        console.log('Data is not used, hiding detail fields');
                        $('#edit_keterangan').prop('disabled', true);
                    }
                    
                    // Tampilkan peringatan jika expired
                    if (data.expired) {
                        $('#expired_warning').removeClass('d-none');
                    }
                    
                    // Tampilkan modal
                    $('#modalEditJatahCuti').modal('show');
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error:', error);
                alert('Terjadi kesalahan saat mengambil data');
            }
        });
    });
    
    // Update JavaScript untuk menangani field tanggal bebas
    $('#edit_dipakai').on('change', function() {
        if ($(this).is(':checked')) {
            $('#edit_keterangan').prop('disabled', false);
            $('#detail_cuti_fields').removeClass('d-none');
            // Set required attributes
            $('#edit_tanggal, #edit_jenis_cuti').prop('required', true);
            
        } else {
            $('#edit_keterangan').prop('disabled', true);
            $('#detail_cuti_fields').addClass('d-none');
            // Remove required attributes and clear values
            $('#edit_tanggal, #edit_jenis_cuti, #edit_file_persetujuan').prop('required', false).val('');
        }
    });
    
    // Update fungsi simpan
    $('#btnSimpanJatahCuti').on('click', function() {
        const karyawanId = $('#edit_karyawan_id').val();
        const tahun = $('#edit_tahun').val();
        const bulan = $('#edit_bulan').val();
        const dipakai = $('#edit_dipakai').is(':checked');
        const keterangan = $('#edit_keterangan').val();
        const tanggal = $('#edit_tanggal').val();
        const jenisCuti = $('#edit_jenis_cuti').val();
        const filePersetujuan = $('#edit_file_persetujuan')[0].files[0];
        
        // Validasi
        if (dipakai && !tanggal) {
            alert('Tanggal cuti wajib diisi ketika status dipakai dipilih');
            return;
        }
        
        if (dipakai && !jenisCuti) {
            alert('Jenis cuti wajib dipilih ketika status dipakai dipilih');
            return;
        }
        
        if (!confirm('Apakah Anda yakin ingin menyimpan perubahan?')) {
            return;
        }
        
        // Tampilkan loading overlay menggunakan template yang sudah ada
        LoadingOverlay.show('Menyimpan data jatah cuti...');
        
        // Disable button untuk mencegah double submit
        $(this).prop('disabled', true);
        $('#btnText').text('Menyimpan...');
        $('#btnSpinner').removeClass('d-none');
        
        // Gunakan FormData untuk file upload
        const formData = new FormData();
        formData.append('karyawan_id', karyawanId);
        formData.append('tahun', tahun);
        formData.append('bulan', bulan);
        formData.append('dipakai', dipakai);
        formData.append('keterangan', keterangan);
        formData.append('tanggal', tanggal);
        formData.append('jenis_cuti', jenisCuti);
        if (filePersetujuan) {
            formData.append('file_persetujuan', filePersetujuan);
        }
        
        // Kirim data via AJAX
        fetch('{% url "update_jatah_cuti_ajax" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // Sembunyikan loading overlay
            LoadingOverlay.hide();
            
            if (data.success) {
                // Tutup modal
                $('#modalEditJatahCuti').modal('hide');
                
                // Refresh halaman untuk menampilkan perubahan
                location.reload();
            } else {
                alert('Gagal memperbarui data: ' + data.message);
                // Reset button state
                resetButtonState();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Sembunyikan loading overlay
            LoadingOverlay.hide();
            alert('Terjadi kesalahan saat memperbarui data');
            // Reset button state
            resetButtonState();
        });
    });
    
    // Fungsi untuk reset button state
    function resetButtonState() {
        $('#btnSimpanJatahCuti').prop('disabled', false);
        $('#btnText').text('Simpan');
        $('#btnSpinner').addClass('d-none');
    }
    
    // Reset button state ketika modal ditutup
    $('#modalEditJatahCuti').on('hidden.bs.modal', function () {
        resetButtonState();
    });
});

</script>
{% endblock javascripts %}
