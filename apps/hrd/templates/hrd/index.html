{% extends 'layouts/base.html' %}
{% load static %}
{% load utils %}

{% block title %} Dashboard {% endblock title %}

{% block content %}
<!-- Birthday Popup -->
{% if has_birthday_today %}
<div id="birthdayPopup" class="birthday-popup">
  <div class="birthday-card">
    <div class="birthday-icon">üéâ</div>
    <h2 class="birthday-title">Selamat Ulang Tahun!</h2>
    <p class="birthday-message">
      Hari ini ada rekan kerja kita yang berulang tahun! üéÇ<br>
      Mari kita ucapkan selamat kepada:
    </p>
    <div class="birthday-names">
      {% for employee in birthday_employees %}
      {{ employee.nama }}{% if not forloop.last %}, {% endif %}
      {% endfor %}
    </div>
    <p class="birthday-message">
      Semoga selalu diberkahi kebahagiaan, kesehatan, dan kesuksesan! üéä
    </p>
    <button class="btn birthday-close-btn" onclick="closeBirthdayPopup()">Tutup üíù</button>
  </div>
</div>
{% endif %}

<!-- Contract Expiring Modal -->
{% if has_expiring_contracts %}
<div class="modal fade" id="contractModal" tabindex="-1" role="dialog" aria-labelledby="contractModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header bg-gradient-danger">
        <div class="d-flex align-items-center">
          <div class="icon icon-shape bg-white text-danger rounded-circle shadow mr-3">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div>
            <h4 class="modal-title text-white mb-0" id="contractModalLabel">
              <i class="fas fa-clock mr-2"></i>Peringatan Kontrak Habis!
            </h4>
            <small class="text-white-50">Ada kontrak yang akan berakhir beberapa hari kedepan</small>
          </div>
        </div>
        <button type="button" class="close text-white" onclick="closeContractPopup()" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <!-- Alert Warning -->
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
          <span class="alert-inner--icon"><i class="fas fa-exclamation-triangle"></i></span>
          <span class="alert-inner--text">
            <strong>Tindakan Segera Diperlukan!</strong>
            Segera lakukan perpanjangan kontrak atau tindakan yang diperlukan.
          </span>
        </div>

        <!-- Employee List -->
        <div class="card shadow-sm">
          <div class="card-header bg-transparent">
            <h5 class="mb-0">
              <i class="fas fa-users text-primary mr-2"></i>
              Daftar Karyawan ({{ expiring_contracts|length }} orang)
            </h5>
          </div>
          <div class="card-body p-0">
            <div class="list-group list-group-flush">
              {% for employee in expiring_contracts %}
              <div class="list-group-item">
                <div class="row align-items-center">
                  <div class="col-auto">
                    <div class="avatar avatar-sm rounded-circle bg-gradient-danger">
                      <span class="avatar-initial text-white font-weight-bold">
                        {{ employee.nama|first|upper }}
                      </span>
                    </div>
                  </div>
                  <div class="col ml--2">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <h4 class="mb-0 text-sm font-weight-bold">{{ employee.nama }}</h4>
                        <p class="text-sm text-muted mb-0">
                          <i class="fas fa-id-badge mr-1"></i>{{ employee.jabatan|default:"Karyawan" }}
                        </p>
                      </div>
                      <div class="text-right">
                        <span class="badge badge-danger badge-pill">
                          <i class="fas fa-calendar-times mr-1"></i>
                          {{ employee.batas_kontrak|date:"d M Y" }}
                        </span>
                        <br>
                        <small class="text-warning font-weight-bold">
                          <i class="fas fa-hourglass-half mr-1"></i>
                          {{ employee.batas_kontrak|timeuntil|truncatewords:2 }}
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer bg-secondary">
        <a href="{% url 'list_karyawan' %}" class="btn btn-warning btn-sm">
          <i class="fas fa-users mr-2"></i>Kelola Karyawan
        </a>
        <button type="button" class="btn btn-secondary btn-sm" onclick="closeContractPopup()" data-autofocus="true">
          <i class="fas fa-times mr-2"></i>Tutup
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Header -->
<div class="header bg-primary pb-6">
  <div class="container-fluid">
    <div class="header-body">
      <div class="row align-items-center py-4">
        <div class="col-lg-6 col-7">
        </div>
        <!-- Jam -->
        <div class="col-lg-6 col-12 mt-3 mt-lg-0 text-lg-right text-center">
          <div class="clock-wrapper d-inline-block">
            <div id="real-time-clock" class="font-weight-bold clock-time text-white">00:00:00 WIB</div>
            <div id="current-date" class="text-white-50 clock-date"></div>
          </div>
        </div>
      </div>
      <!-- Card stats -->
      <div class="row">

        <!-- Total Karyawan Tetap Aktif -->
        <div class="col-xl-3 col-md-6">
          <div class="card card-stats">
            <div class="card-body">
              <div class="row">
                <div class="col">
                  <h5 class="card-title text-uppercase text-muted mb-0">Total Karyawan</h5>
                  <span class="h2 font-weight-bold mb-0 counter">{{ total_karyawan_tetap }}</span>
                </div>
                <div class="col-auto">
                  <div class="icon icon-shape bg-gradient-red text-white rounded-circle shadow">
                    <i class="ni ni-single-02"></i>
                  </div>
                </div>
              </div>
              <p class="mt-3 mb-0 text-sm">
                <span class="text-muted"><i class="fa fa-info-circle"></i> Karyawan tetap aktif</span>
              </p>
            </div>
          </div>
        </div>

        <!-- Total Cuti -->
        <div class="col-xl-3 col-md-6">
          <div class="card card-stats">
            <div class="card-body">
              <div class="row">
                <div class="col">
                  <h5 class="card-title text-uppercase text-muted mb-0">Total Cuti</h5>
                  <span class="h2 font-weight-bold mb-0 counter">{{ total_cuti }}</span>
                </div>
                <div class="col-auto">
                  <div class="icon icon-shape bg-gradient-orange text-white rounded-circle shadow">
                    <i class="ni ni-calendar-grid-58"></i>
                  </div>
                </div>
              </div>
              <p class="mt-3 mb-0 text-sm">
                <span class="text-success mr-2"><i class="fa fa-calendar-alt"></i> Bulan ini</span>
                <span class="text-nowrap">{{ cuti_bulan_ini }} disetujui</span>
              </p>
            </div>
          </div>
        </div>

        <!-- Total Izin WFA -->
        <div class="col-xl-3 col-md-6">
          <div class="card card-stats">
            <div class="card-body">
              <div class="row">
                <div class="col">
                  <h5 class="card-title text-uppercase text-muted mb-0">Total Izin WFA</h5>
                  <span class="h2 font-weight-bold mb-0">{{ total_izin_wfa }}</span>
                </div>
                <div class="col-auto">
                  <div class="icon icon-shape bg-gradient-green text-white rounded-circle shadow">
                    <i class="ni ni-laptop"></i>
                  </div>
                </div>
              </div>
              <p class="mt-3 mb-0 text-sm">
                <span class="text-primary"><i class="fa fa-home"></i> Bulan ini</span>
              </p>
            </div>
          </div>
        </div>

        <!-- Total Izin Telat -->
        <div class="col-xl-3 col-md-6">
          <div class="card card-stats">
            <div class="card-body">
              <div class="row">
                <div class="col">
                  <h5 class="card-title text-uppercase text-muted mb-0">Total Izin Telat</h5>
                  <span class="h2 font-weight-bold mb-0">{{ total_izin_telat }}</span>
                </div>
                <div class="col-auto">
                  <div class="icon icon-shape bg-gradient-info text-white rounded-circle shadow">
                    <i class="ni ni-time-alarm"></i>
                  </div>
                </div>
              </div>
              <p class="mt-3 mb-0 text-sm">
                <span class="text-info"><i class="fa fa-clock"></i> {{ telat_bulan_ini }} disetujui</span>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Page content -->
<div class="container-fluid mt--6">
  <!-- Filter Bulan & Tahun -->

  <!-- Filter Bulan & Tahun -->
  <div class="enhanced-filter-container">
    <form method="get" class="filter-form-enhanced">
      <div class="filter-group-enhanced">
        <label for="bulan">
          <i class="fas fa-calendar-alt filter-icon"></i>
          Bulan
        </label>
        <select name="bulan" id="bulan" class="form-control">
          <option value="">Semua Bulan</option>
          {% for key, value in bulan_choices %}
          <option value="{{ key }}" {% if key == selected_bulan %}selected{% endif %}>
            {{ value }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="filter-group-enhanced">
        <label for="tahun">
          <i class="fas fa-calendar filter-icon"></i>
          Tahun
        </label>
        <select name="tahun" id="tahun" class="form-control">
          <option value="">Semua Tahun</option>
          {% for tahun in tahun_choices %}
          <option value="{{ tahun }}" {% if tahun == selected_tahun %}selected{% endif %}>
            {{ tahun }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="filter-group-enhanced">
        <button type="submit" class="btn btn-filter-enhanced">
          <i class="fas fa-search"></i>
          Filter
        </button>
      </div>
    </form>

  </div>



  <div class="row">
    <div class="col-xl-8">
      <div class="card">
        <div class="card-header bg-transparent">
          <div class="row align-items-center">
            <div class="col">
              <h6 class="text-uppercase text-muted ls-1 mb-1">Statistik Cuti & Izin</h6>
              <h5 class="h3 mb-0">Per Bulan - Tahun {{ selected_tahun }}</h5>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="chart">
            <canvas id="chart-cuti-izin" class="chart-canvas"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-4">
      <div class="card">
        <div class="card-header bg-transparent">
          <div class="row align-items-center">
            <div class="col">
              <h6 class="text-uppercase text-muted ls-1 mb-1">Tren Cuti</h6>
              <h3 class="h3 mb-0">Top Jenis Cuti</h3>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="chart">
            <canvas id="chart-top-jenis-cuti" class="chart-canvas"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-xl-4">
      <div class="card">
        <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
          <h3 class="mb-0">Pengajuan Belum Diproses</h3>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <a href="{% url 'approval_cuti' %}">Pengajuan Cuti</a>
              <span class="badge badge-primary badge-pill">{{ jumlah_cuti_menunggu }}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <a href="{% url 'approval_izin' %}">Pengajuan Izin</a>
              <span class="badge badge-warning badge-pill">{{ jumlah_izin_menunggu }}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <a href="{% url 'approval_cuti' %}">Tidak Ambil Cuti Bersama</a>
              <span class="badge badge-info badge-pill">{{ jumlah_tidak_ambil_cuti_menunggu }}</span>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="col-xl-4">
      <div class="card">
        <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
          <h3 class="mb-0">Jumlah Karyawan Tiap Divisi</h3>
        </div>
        <div class="card-body">
          <!-- Tempat render data via JS -->
          <ul class="list-group list-group-flush" id="divisi-list"></ul>

          <!-- Tombol paginasi -->
          <div class="mt-3 d-flex justify-content-between" id="pagination-divisi-controls"></div>
        </div>
      </div>
    </div>
    <div class="col-xl-4">
      <div class="card">
        <div class="card-header bg-transparent">
          <h3 class="mb-0">Libur Nasional Terdekat</h3>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush" id="libur-list">
            {% for libur in page_obj_libur %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              {{ libur.summary }}
              <span class="badge badge-danger badge-pill">{{ libur.date|date:"d M Y" }}</span>
            </li>
            {% empty %}
            <li class="list-group-item text-muted">Tidak ada libur nasional terdekat.</li>
            {% endfor %}
          </ul>
          <div class="mt-3 d-flex justify-content-between" id="pagination-controls">
            {% if page_obj_libur.has_previous %}
            <a href="?page_libur={{ page_obj_libur.previous_page_number }}" class="btn btn-sm btn-outline-primary">
              &laquo; Sebelumnya
            </a>
            {% else %}
            <span></span>
            {% endif %}

            {% if page_obj_libur.has_next %}
            <a href="?page_libur={{ page_obj_libur.next_page_number }}" class="btn btn-sm btn-outline-primary ml-auto">
              Selanjutnya &raquo;
            </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Kalender HR -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h6 class="text-uppercase text-muted ls-1 mb-1">Calender</h6>
          <h3 class="mb-0">Kalender Kegiatan CESGS</h3>
        </div>
        <div class="card-body">
          <div id="calendar"></div>
        </div>
      </div>
    </div>
  </div>

  {% include "includes/footer.html" %}

</div>

{% endblock content %}

<!-- Specific JS goes HERE -->
{% block javascripts %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar/index.global.min.js"></script>


<script>
</script>


<script>
  (function() {
    const canvas = document.getElementById('chart-cuti-izin');
    if (!canvas) return;

    // Hapus chart lama jika sudah ada
    if (window.chartInstances && window.chartInstances['chart-cuti-izin']) {
      window.chartInstances['chart-cuti-izin'].destroy();
    }

    const ctxCutiIzin = canvas.getContext('2d');
    const chartCutiIzin = new Chart(ctxCutiIzin, {
      type: 'line',
      data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'],
        datasets: [
          {
            label: 'Cuti',
            data: {{ cuti_chart|safe }},
            borderColor: 'rgba(54, 162, 235, 1)',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            fill: true,
            tension: 0.4,
            borderWidth: 3,
            pointBackgroundColor: 'rgba(54, 162, 235, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 5,
            pointHoverRadius: 7
          },
          {
            label: 'Izin',
            data: {{ izin_chart|safe }},
            borderColor: 'rgba(255, 99, 132, 1)',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            fill: true,
            tension: 0.4,
            borderWidth: 3,
            pointBackgroundColor: 'rgba(255, 99, 132, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 5,
            pointHoverRadius: 7
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          intersect: false,
          mode: 'index'
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              font: {
                size: 14
              },
              usePointStyle: true,
              padding: 20
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#fff',
            bodyColor: '#fff',
            borderColor: 'rgba(255, 255, 255, 0.1)',
            borderWidth: 1,
            cornerRadius: 8,
            displayColors: true,
            callbacks: {
              title: function(context) {
                return 'Bulan ' + context[0].label;
              },
              label: function(context) {
                return context.dataset.label + ': ' + context.parsed.y + ' orang';
              }
            }
          }
        },
        scales: {
          x: {
            grid: {
              display: true,
              color: 'rgba(0, 0, 0, 0.1)'
            },
            ticks: {
              font: {
                size: 12
              }
            }
          },
          y: {
            beginAtZero: true,
            grid: {
              display: true,
              color: 'rgba(0, 0, 0, 0.1)'
            },
            ticks: {
              font: {
                size: 12
              },
              callback: function(value) {
                return value + ' orang';
              }
            }
          }
        },
        elements: {
          point: {
            hoverBorderWidth: 3
          }
        }
      }
    });

    // Simpan instance chart
    if (!window.chartInstances) window.chartInstances = {};
    window.chartInstances['chart-cuti-izin'] = chartCutiIzin;
  })();
</script>

<style>
  /* Tambahan CSS untuk responsivitas card calendar */
  .card {
    overflow-x: auto;
  }

  .card-body {
    padding: 1rem;
  }

  @media (max-width: 576px) {
    .card-body {
      padding: 0.5rem;
    }

    .card-header h3 {
      font-size: 1.1rem;
    }
  }

  /* Perbaikan untuk tabel yang overflow */
  .table-responsive {
    border: none;
  }

  @media (max-width: 768px) {
    .table-responsive {
      font-size: 0.875rem;
    }

    .table th,
    .table td {
      padding: 0.5rem 0.25rem;
    }
  }

  /* Custom tooltip styles */
  .custom-tooltip-wrapper {
    max-width: 300px;
  }

  .custom-tooltip {
    text-align: left;
    padding: 10px;
  }

  .tooltip-title {
    color: #fff;
    font-weight: bold;
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    padding-bottom: 5px;
    margin-bottom: 8px;
  }

  .tooltip-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .tooltip-item {
    padding: 2px 0;
    color: #fff;
    font-size: 12px;
  }
</style>

<script>
  // Inisialisasi calendar dinamis (boleh dipanggil ulang)
  function initializeCalendar(events) {
    const calendarEl = document.getElementById('calendar');

    if (!calendarEl) {
      console.error('Calendar element not found');
      return;
    }

    // Hapus instance lama jika ada
    if (window.calendarInstance) {
      window.calendarInstance.destroy();
    }

    // Buat instance baru
    const calendar = new FullCalendar.Calendar(calendarEl, {
      themeSystem: 'bootstrap5',
      initialView: 'dayGridMonth',
      aspectRatio: window.innerWidth < 768 ? 1.0 : 1.5,
      height: 'auto',
      headerToolbar: {
        left: window.innerWidth < 576 ? 'prev,next' : 'prev,next today',
        center: 'title',
        right: window.innerWidth < 576 ? 'listMonth' : 'dayGridMonth,timeGridWeek,listMonth'
      },
      locale: 'id',
      // hiddenDays: [0], // show sunday
      firstDay: 1,
      dayMaxEvents: window.innerWidth < 576 ? 2 : true,
      events: events || "/hrd/kalender/events/",
      eventDidMount: function (info) {
        if (info.event.extendedProps.description) {
          // Check if bootstrap is available
          if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
            new bootstrap.Tooltip(info.el, {
              title: info.event.extendedProps.description || info.event.title,
              placement: "top",
              trigger: "hover",
              container: "body"
            });
          }
        }
      },
      eventDisplay: 'block',
      displayEventTime: window.innerWidth > 576,

      // Responsif settings
      windowResize: function () {
        const isMobile = window.innerWidth < 576;
        const isTablet = window.innerWidth < 768;

        calendar.setOption('headerToolbar', {
          left: isMobile ? 'prev,next' : 'prev,next today',
          center: 'title',
          right: isMobile ? 'listMonth' : 'dayGridMonth,timeGridWeek,listMonth'
        });

        calendar.setOption('dayMaxEvents', isMobile ? 2 : true);
        calendar.setOption('displayEventTime', !isMobile);
        calendar.setOption('aspectRatio', isTablet ? 1.0 : 1.5);
      }
    });

    calendar.render();
    window.calendarInstance = calendar;
  }

  // Load saat halaman siap
  document.addEventListener('DOMContentLoaded', function () {
    // Initialize calendar
    try {
      initializeCalendar();
    } catch (error) {
      console.error('Error initializing calendar:', error);
    }
  });
</script>

<script>
  const ctxTopJenisCuti = document.getElementById('chart-top-jenis-cuti');
  if (ctxTopJenisCuti) {
    const chartTopJenisCuti = new Chart(ctxTopJenisCuti.getContext('2d'), {
      type: 'pie',
      data: {
        labels: {{ top_cuti_labels|safe }},
        datasets: [{
          label: 'Total Pengajuan',
          data: {{ top_cuti_values|safe }},
          backgroundColor: [
            'rgba(54, 162, 235, 0.6)',
            'rgba(255, 206, 86, 0.6)',
            'rgba(75, 192, 192, 0.6)',
            'rgba(153, 102, 255, 0.6)',
            'rgba(255, 159, 64, 0.6)'
          ],
          borderColor: [
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(153, 102, 255, 1)',
            'rgba(255, 159, 64, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
            labels: {
              font: {
                size: 12
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                const total = context.dataset.data.reduce((acc, data) => acc + data, 0);
                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                return `${label}: ${value} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
  }
</script>

<!-- paginasi libur -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    try {
      const liburData = {{ libur_json|default:'[]'|safe }};
      const perPage = 3;
      let currentPage = 1;

      function renderLibur() {
        const listContainer = document.getElementById('libur-list');
        const pagination = document.getElementById('pagination-controls');

        if (!listContainer || !pagination) {
          console.error('Libur elements not found');
          return;
        }

        listContainer.innerHTML = '';
        pagination.innerHTML = '';

        const start = (currentPage - 1) * perPage;
        const end = start + perPage;
        const pageItems = liburData.slice(start, end);

        if (pageItems.length === 0) {
          listContainer.innerHTML = `<li class="list-group-item text-muted">Tidak ada libur nasional.</li>`;
          return;
        }

        pageItems.forEach(item => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.innerHTML = `
            ${item.summary}
            <span class="badge badge-danger badge-pill">${formatDate(item.date)}</span>
          `;
          listContainer.appendChild(li);
        });

        // Paginasi tombol
        const totalPages = Math.ceil(liburData.length / perPage);
        if (currentPage > 1) {
          const prevBtn = document.createElement('button');
          prevBtn.className = 'btn btn-sm btn-outline-primary';
          prevBtn.innerHTML = '&laquo; Sebelumnya';
          prevBtn.onclick = () => {
            currentPage--;
            renderLibur();
          };
          pagination.appendChild(prevBtn);
        }

        if (currentPage < totalPages) {
          const nextBtn = document.createElement('button');
          nextBtn.className = 'btn btn-sm btn-outline-primary ml-auto';
          nextBtn.innerHTML = 'Selanjutnya &raquo;';
          nextBtn.onclick = () => {
            currentPage++;
            renderLibur();
          };
          pagination.appendChild(nextBtn);
        }
      }

      function formatDate(dateStr) {
        try {
          const date = new Date(dateStr);
          const options = { day: '2-digit', month: 'short', year: 'numeric' };
          return date.toLocaleDateString('id-ID', options);
        } catch (error) {
          console.error('Error formatting date:', error);
          return dateStr;
        }
      }

      renderLibur();
    } catch (error) {
      console.error('Error in libur pagination:', error);
    }
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    try {
      const divisiData = {{ jumlah_divisi_json|safe }};
      const perPageDivisi = 3;
      let currentPageDivisi = 1;

      function renderDivisi() {
        const list = document.getElementById('divisi-list');
        const pagination = document.getElementById('pagination-divisi-controls');

        if (!list || !pagination) {
          console.error('Divisi elements not found');
          return;
        }

        list.innerHTML = '';
        pagination.innerHTML = '';

        const start = (currentPageDivisi - 1) * perPageDivisi;
        const end = start + perPageDivisi;
        const pageItems = divisiData.slice(start, end);

        if (pageItems.length === 0) {
          list.innerHTML = `<li class="list-group-item text-muted">Tidak ada data divisi.</li>`;
          return;
        }

        pageItems.forEach(item => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center position-relative';

          // Buat custom tooltip content dengan styling
          const tooltipContent = `
            <div class="custom-tooltip">
              <h6 class="tooltip-title mb-2">Daftar Karyawan ${item.divisi_label}</h6>
              <ul class="tooltip-list">
                ${item.karyawan.map(nama => `<li class="tooltip-item"><i class="fas fa-user mr-2"></i>${nama}</li>`).join('')}
              </ul>
            </div>
          `;

          li.innerHTML = `
            <span class="text-primary" data-toggle="tooltip" data-html="true" title="${tooltipContent.replace(/"/g, '&quot;')}">
              <i class="fas fa-users mr-2"></i>${item.divisi_label}
            </span>
            <span class="badge badge-success badge-pill cursor-pointer" onclick="window.location.href='/hrd/manajemen-karyawan/?divisi=${encodeURIComponent(item.divisi_value)}'">${item.jumlah}</span>
          `;
          list.appendChild(li);
        });

        // Initialize tooltips with jQuery if available
        if (typeof $ !== 'undefined') {
          $('[data-toggle="tooltip"]').tooltip({
            placement: 'right',
            html: true,
            template: '<div class="tooltip custom-tooltip-wrapper" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>',
            animation: true
          });
        }

        // Pagination
        const totalPages = Math.ceil(divisiData.length / perPageDivisi);
        if (currentPageDivisi > 1) {
          const prevBtn = document.createElement('button');
          prevBtn.className = 'btn btn-sm btn-outline-primary';
          prevBtn.innerHTML = '&laquo; Sebelumnya';
          prevBtn.onclick = () => {
            currentPageDivisi--;
            renderDivisi();
          };
          pagination.appendChild(prevBtn);
        }

        if (currentPageDivisi < totalPages) {
          const nextBtn = document.createElement('button');
          nextBtn.className = 'btn btn-sm btn-outline-primary ml-auto';
          nextBtn.innerHTML = 'Selanjutnya &raquo;';
          nextBtn.onclick = () => {
            currentPageDivisi++;
            renderDivisi();
          };
          pagination.appendChild(nextBtn);
        }
      }

      renderDivisi();
    } catch (error) {
      console.error('Error in divisi pagination:', error);
    }
  });
</script>

<script>
  // Fungsi untuk jam
  function updateClock() {
    try {
      const now = new Date();
      const jam = now.getHours().toString().padStart(2, '0');
      const menit = now.getMinutes().toString().padStart(2, '0');
      const detik = now.getSeconds().toString().padStart(2, '0');
      const currentTime = `${jam}:${menit}:${detik} WIB`;

      const clockElement = document.getElementById('real-time-clock');
      const dateElement = document.getElementById('current-date');

      if (clockElement) {
        clockElement.textContent = currentTime;
      }

      if (dateElement) {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        dateElement.textContent = now.toLocaleDateString('id-ID', options);
      }
    } catch (error) {
      console.error('Error updating clock:', error);
    }
  }

  // Jalankan pertama kali & per detik
  setInterval(updateClock, 1000);
  updateClock();
</script>

<script>
  function closeBirthdayPopup() {
    const popup = document.getElementById('birthdayPopup');
    if (popup) {
      popup.style.display = 'none';
    }
  }

  function closeContractPopup() {
    const modal = document.getElementById('contractModal');
    if (typeof $ !== 'undefined' && modal) {
      $('#contractModal').modal('hide');
      return;
    }
    if (modal) {
      modal.style.display = 'none';
      modal.classList.remove('show');
      modal.setAttribute('inert', '');
      modal.setAttribute('aria-hidden', 'true');
      // Remove modal backdrop
      const backdrop = document.querySelector('.modal-backdrop');
      if (backdrop) {
        backdrop.remove();
      }
      // Restore body scroll
      document.body.classList.remove('modal-open');
      document.body.style.paddingRight = '';
    }
  }

  // Auto close birthday popup after 15 seconds
  {% if has_birthday_today %}
  setTimeout(function () {
    closeBirthdayPopup();
  }, 15000);
  {% endif %}

  // Auto close contract modal after 25 seconds
  {% if has_expiring_contracts %}
  setTimeout(function () {
    closeContractPopup();
  }, 25000);
  {% endif %}

  // Initialize contract modal
  {% if has_expiring_contracts %}
  document.addEventListener('DOMContentLoaded', function () {
    if (typeof $ !== 'undefined' && $('#contractModal').length) {
      $('#contractModal').modal({ backdrop: true, keyboard: true, show: true });
    } else {
      var modal = document.getElementById('contractModal');
      if (modal) {
        modal.style.display = 'block';
        modal.classList.add('show');
        modal.removeAttribute('inert');
        modal.setAttribute('aria-hidden', 'false');
        document.body.classList.add('modal-open');
      }
    }
  });
  {% endif %}
</script>

{% endblock javascripts %}