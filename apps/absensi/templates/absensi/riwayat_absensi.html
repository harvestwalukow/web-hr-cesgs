{% extends "layouts/base.html" %}
{% load static %}
{% block title %}Riwayat Absensi{% endblock %}

{% block content %}
<!-- Header -->
<div class="header bg-primary pb-6">
    <div class="container-fluid">
        <div class="header-body">
            <div class="row align-items-center py-4">
                <div class="col-lg-6 col-7">
                    <h6 class="h2 text-white d-inline-block mb-0">Riwayat Absensi</h6>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Page content -->
<div class="container-fluid mt--6">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-body">
                <!-- Filter Section -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body filter-section">
                        <form method="get">
                            <div class="form-row align-items-end">
                                <div class="form-group col-md-3">
                                    <label class="form-control-label">BULAN</label>
                                    <select name="bulan" class="form-control form-control-alternative">
                                        <option value="">Semua Bulan</option>
                                        {% for month_num, month_name in months %}
                                            <option value="{{ month_num }}" {% if month_num == selected_month %}selected{% endif %}>{{ month_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group col-md-3">
                                    <label class="form-control-label">TAHUN</label>
                                    <select name="tahun" class="form-control form-control-alternative">
                                        <option value="">Semua Tahun</option>
                                        {% for year in years %}
                                            <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group col-md-3">
                                    <label class="form-control-label">KETERANGAN</label>
                                    <select name="keterangan" class="form-control form-control-alternative">
                                        <option value="">Semua Keterangan</option>
                                        <option value="WFO" {% if selected_keterangan == 'WFO' %}selected{% endif %}>WFO</option>
                                        <option value="WFA" {% if selected_keterangan == 'WFA' %}selected{% endif %}>WFA</option>
                                        <option value="Izin Telat" {% if selected_keterangan == 'Izin Telat' %}selected{% endif %}>Izin Telat</option>
                                        <option value="Izin Sakit" {% if selected_keterangan == 'Izin Sakit' %}selected{% endif %}>Izin Sakit</option>
                                    </select>
                                </div>
                                <div class="form-group col-md-3 text-right">
                                    <button type="submit" class="btn btn-primary btn-block mt-2">
                                        <i class="fas fa-filter mr-2"></i>Filter
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>


                    <!-- Summary Cards -->
                    <div class="row mb-4">
                        <div class="col-xl-4 col-md-4 mb-3">
                            <div class="card card-stats shadow-sm summary-card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col">
                                            <h5 class="card-title text-uppercase text-muted mb-0">Total Absensi</h5>
                                            <span class="h2 font-weight-bold mb-0">{{ total_absensi }}</span>
                                        </div>
                                        <div class="col-auto">
                                            <div class="icon icon-shape bg-gradient-info text-white rounded-circle shadow">
                                                <i class="ni ni-chart-bar-32"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-4 col-md-4 mb-3">
                            <div class="card card-stats shadow-sm summary-card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col">
                                            <h5 class="card-title text-uppercase text-muted mb-0">WFO</h5>
                                            <span class="h2 font-weight-bold mb-0">{{ total_wfo|default:0 }}</span>
                                        </div>
                                        <div class="col-auto">
                                            <div class="icon icon-shape bg-gradient-success text-white rounded-circle shadow">
                                                <i class="ni ni-building"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-4 col-md-4 mb-3">
                            <div class="card card-stats shadow-sm summary-card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col">
                                            <h5 class="card-title text-uppercase text-muted mb-0">WFA</h5>
                                            <span class="h2 font-weight-bold mb-0">{{ total_wfa|default:0 }}</span>
                                        </div>
                                        <div class="col-auto">
                                            <div class="icon icon-shape bg-gradient-warning text-white rounded-circle shadow">
                                                <i class="ni ni-laptop"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Attendance List -->
                    <div class="row">
                        {% if absensi_list %}
                            {% for absensi in absensi_list %}
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card shadow-sm attendance-card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h4 class="mb-0">{{ absensi.tanggal|date:"d F Y" }}</h4>
                                                <span class="badge badge-pill {% if absensi.keterangan == 'WFO' %}badge-success{% else %}badge-info{% endif %}">
                                                    {{ absensi.keterangan|default:'-' }}
                                                </span>
                                            </div>
                                            
                                            <div class="d-flex justify-content-between mb-2">
                                                <span class="text-muted text-sm">
                                                    <i class="ni ni-time-alarm mr-1"></i>
                                                    Masuk: {% if absensi.jam_masuk %}{{ absensi.jam_masuk|time:"H:i" }}{% else %}-{% endif %}
                                                </span>
                                                <span class="text-muted text-sm">
                                                    <i class="ni ni-button-power mr-1"></i>
                                                    Pulang: {% if absensi.jam_pulang %}{{ absensi.jam_pulang|time:"H:i" }}{% else %}-{% endif %}
                                                </span>
                                            </div>
                                            
                                            <div class="border-top pt-2">
                                                <p class="text-muted text-sm mb-1">
                                                    <i class="fas fa-map-marker-alt mr-1"></i> 
                                                    <strong>Masuk:</strong> {{ absensi.alamat_masuk|default:'-'|truncatechars:50 }}
                                                </p>
                                                {% if absensi.alamat_pulang %}
                                                <p class="text-muted text-sm mb-0">
                                                    <i class="fas fa-map-marker-alt mr-1"></i> 
                                                    <strong>Pulang:</strong> {{ absensi.alamat_pulang|truncatechars:50 }}
                                                </p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="col-12">
                                <div class="alert alert-info" role="alert">
                                    <span class="alert-icon"><i class="ni ni-bell-55"></i></span>
                                    <span class="alert-text">Tidak ada data absensi yang ditemukan untuk filter yang dipilih.</span>
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    <div class="row mb-4">
                        <div class="col-12 mt-2">
                            <p class="text-muted text-sm italic mb-0">
                                <i class="fas fa-info-circle mr-1"></i>
                                Titik GPS terkadang tidak 100% akurat.
                            </p>
                        </div>
                    </div>

                    
                    <!-- Pagination -->
                    {% with page_obj=absensi_list %}
                        {% include 'includes/pagination.html' %}
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Screenshot Modal -->
<div class="modal fade" id="screenshotModal" tabindex="-1" role="dialog" aria-labelledby="screenshotModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="screenshotModalLabel">Screenshot Absensi</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-center">
                <img src="" id="modalScreenshot" class="img-fluid rounded" alt="Screenshot Absensi">
            </div>
        </div>
    </div>
</div>

{% include 'includes/footer.html' %}
{% endblock %}

{% block javascripts %}
<script>
    $(document).ready(function() {
        $('#screenshotModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget); // Button that triggered the modal
            var screenshotUrl = button.data('screenshot-url'); // Extract info from data-* attributes
            var modal = $(this);
            modal.find('#modalScreenshot').attr('src', screenshotUrl);
            
            // Menentukan judul modal berdasarkan jenis screenshot
            var altText = button.find('img').attr('alt');
            if (altText.includes('Masuk')) {
                modal.find('.modal-title').text('Screenshot Absen Masuk');
            } else if (altText.includes('Pulang')) {
                modal.find('.modal-title').text('Screenshot Absen Pulang');
            } else {
                modal.find('.modal-title').text('Screenshot Absensi');
            }
        });
    });
</script>
{% endblock %}