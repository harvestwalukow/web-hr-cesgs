{% extends "layouts/base.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="header bg-primary pb-6">
    <div class="container-fluid">
        <div class="header-body">
            <div class="row align-items-center py-4">
                <div class="col-lg-6 col-7">
                    <h6 class="h2 text-white d-inline-block mb-0">{{ title }}</h6>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid mt--6">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-soft border-0">
                <div class="card-header bg-white border-0">
                    <h4 class="card-title mb-0 text-primary font-weight-bold"><i class="fas fa-fingerprint mr-2"></i> {{ title }}</h4>
                </div>
                <div class="card-body">
                    {% if absensi_hari_ini and not title == "Absensi Pulang" or absensi_hari_ini.jam_pulang %}
                        <div class="alert alert-success alert-dismissible fade show border-0 shadow-sm" role="alert">
                            <span class="alert-icon"><i class="ni ni-like-2"></i></span>
                            <span class="alert-text"><strong>Selamat!</strong> Anda sudah melakukan absensi hari ini!</span>
                            <hr class="my-3">
                            <p class="mb-0">
                                Waktu absen masuk: <strong>{{ absensi_hari_ini.jam_masuk|time:"H:i:s" }}</strong><br>
                                {% if absensi_hari_ini.jam_pulang %}
                                Waktu absen pulang: <strong>{{ absensi_hari_ini.jam_pulang|time:"H:i:s" }}</strong><br>
                                {% endif %}
                                Status: <strong>{{ absensi_hari_ini.status }}</strong><br>
                                Alamat: <strong>{{ absensi_hari_ini.alamat_masuk|default:"-" }}</strong>
                            </p>
                        </div>
                    {% else %}
                        <div class="row">
                            <div class="col-lg-7 mb-4">
                                <div class="p-4 bg-secondary rounded shadow-inset">
                                    <div class="form-group mb-3">
                                        <label class="form-control-label text-muted">Nama Lengkap</label>
                                        <div class="input-group input-group-merge input-group-alternative">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="ni ni-single-02"></i></span>
                                            </div>
                                            <input type="text" class="form-control font-weight-600" value="{{ karyawan.nama }}" readonly>
                                        </div>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-control-label text-muted">Jabatan / Role</label>
                                        <div class="input-group input-group-merge input-group-alternative">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="ni ni-badge"></i></span>
                                            </div>
                                            <input type="text" class="form-control" value="{{ request.user.get_role_display }}" readonly>
                                        </div>
                                    </div>
                                    <div class="form-group mb-4">
                                        <label class="form-control-label text-muted">Tanggal Presensi</label>
                                        <div class="input-group input-group-merge input-group-alternative">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="ni ni-calendar-grid-58"></i></span>
                                            </div>
                                            <input type="text" class="form-control text-primary font-weight-bold" value="{% now 'd F Y' %}" readonly>
                                        </div>
                                    </div>

                                    <form id="absenForm" method="post" action="{% if title == 'Absensi Pulang' %}{% url 'absen_pulang_magang' %}{% else %}{% url 'absen_magang' %}{% endif %}">
                                        {% csrf_token %}
                                        <div class="form-group mb-4">
                                            <label class="form-control-label">Keterangan / Aktivitas</label>
                                            <textarea name="keterangan" class="form-control form-control-alternative" rows="3" placeholder="Tuliskan aktivitas Anda hari ini..." required></textarea>
                                        </div>
                                        
                                        <input type="hidden" name="latitude" id="hiddenLatitude">
                                        <input type="hidden" name="longitude" id="hiddenLongitude">
                                        
                                        <button type="submit" id="absenButton" class="btn btn-primary btn-block btn-lg shadow" disabled>
                                            <i class="fas fa-check-circle mr-2"></i> Submit Absensi
                                        </button>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="col-lg-5">
                                <div class="card bg-gradient-white border-0 shadow-soft">
                                    <div class="card-body">
                                        <h5 class="h4 text-primary mb-4"><i class="fas fa-map-marked-alt mr-2"></i> Validasi Lokasi</h5>
                                        
                                        <div class="location-card p-3 rounded mb-3" style="background: #f8f9fe; border-left: 5px solid #5e72e4;">
                                            <div id="locationStatus" class="d-flex align-items-center mb-2">
                                                <div class="spinner-border spinner-border-sm text-primary mr-2" role="status"></div>
                                                <span class="text-muted font-italic">Mendeteksi lokasi Anda...</span>
                                            </div>
                                            
                                            <div id="locationCoords" class="mt-2" style="display: none;">
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span class="text-sm text-muted">Latitude:</span>
                                                    <span id="latitude" class="text-sm font-weight-bold">-</span>
                                                </div>
                                                <div class="d-flex justify-content-between mb-1">
                                                    <span class="text-sm text-muted">Longitude:</span>
                                                    <span id="longitude" class="text-sm font-weight-bold">-</span>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <span class="text-sm text-muted">Akurasi:</span>
                                                    <span id="accuracy" class="text-sm font-weight-bold">- meter</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="alert alert-neutral shadow-sm border-0 mt-4" role="alert">
                                            <div class="d-flex align-items-start">
                                                <i class="fas fa-info-circle text-info mt-1 mr-3"></i>
                                                <div>
                                                    <h6 class="mb-1 text-info">Ketentuan Geofencing</h6>
                                                    <p class="text-xs mb-0 text-muted">Anda hanya dapat melakukan absensi jika berada dalam radius <strong>150 meter</strong> dari area ASEEC.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'includes/footer.html' %}
{% endblock %}

{% block javascripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const locationStatus = document.getElementById('locationStatus');
        const locationCoords = document.getElementById('locationCoords');
        const latitudeEl = document.getElementById('latitude');
        const longitudeEl = document.getElementById('longitude');
        const accuracyEl = document.getElementById('accuracy');
        const hiddenLatitude = document.getElementById('hiddenLatitude');
        const hiddenLongitude = document.getElementById('hiddenLongitude');
        const absenButton = document.getElementById('absenButton');
        
        let locationAvailable = false;

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const acc = position.coords.accuracy;

                        latitudeEl.textContent = lat.toFixed(6);
                        longitudeEl.textContent = lon.toFixed(6);
                        accuracyEl.textContent = acc.toFixed(1) + ' m';
                        locationCoords.style.display = 'block';

                        hiddenLatitude.value = lat;
                        hiddenLongitude.value = lon;

                        // Validasi geofencing via API
                        const checkUrl = "{% url 'check_location' %}";
                        fetch(`${checkUrl}?lat=${lat}&lon=${lon}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.is_within_geofence) {
                                    locationStatus.innerHTML = `
                                        <div class="badge badge-pill badge-success">
                                            <i class="fas fa-check-circle mr-1"></i> Lokasi Valid (ASEEC)
                                        </div>
                                    `;
                                    locationAvailable = true;
                                    absenButton.disabled = false;
                                    absenButton.classList.remove('btn-secondary');
                                    absenButton.classList.add('btn-primary', 'animate-pulse');
                                } else {
                                    locationStatus.innerHTML = `
                                        <div class="badge badge-pill badge-danger">
                                            <i class="fas fa-times-circle mr-1"></i> ${data.message}
                                        </div>
                                    `;
                                    locationAvailable = false;
                                    absenButton.disabled = true;
                                }
                            })
                            .catch(error => {
                                console.error('Error checking location:', error);
                                locationStatus.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle mr-1"></i> Gagal validasi geofence</span>';
                            });
                    },
                    function(error) {
                        let msg = "Gagal mendapatkan lokasi";
                        switch(error.code) {
                            case error.PERMISSION_DENIED: msg = "Izin lokasi ditolak. Klik icon gembok di address bar untuk mengaktifkan."; break;
                            case error.POSITION_UNAVAILABLE: msg = "Lokasi tidak tersedia"; break;
                            case error.TIMEOUT: msg = "Waktu permintaan habis"; break;
                        }
                        locationStatus.innerHTML = `
                            <span class="text-danger"><i class="fas fa-exclamation-triangle mr-1"></i> ${msg}</span>
                            <button type="button" class="btn btn-sm btn-outline-primary ml-2" onclick="location.reload()">
                                <i class="fas fa-sync-alt mr-1"></i> Coba Lagi
                            </button>
                        `;
                    },
                    { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 }
                );
            } else {
                locationStatus.innerHTML = '<span class="text-danger">Geolocation tidak didukung browser ini.</span>';
            }
        }

        getLocation();
    });
</script>

<style>
    .shadow-soft {
        box-shadow: 0 0.75rem 1.5rem rgba(18, 38, 63, 0.03) !important;
    }
    .shadow-inset {
        box-shadow: inset 2px 2px 5px #babecc, inset -5px -5px 10px #ffffff !important;
    }
    .animate-pulse {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(94, 114, 228, 0.7); }
        70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(94, 114, 228, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(94, 114, 228, 0); }
    }
</style>
{% endblock %}