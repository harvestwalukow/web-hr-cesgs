{% extends "layouts/base.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="header bg-primary pb-6">
    <div class="container-fluid">
        <div class="header-body">
            <div class="row align-items-center py-4">
                <div class="col-lg-6 col-7">
                    <h6 class="h2 text-white d-inline-block mb-0">{{ title }}</h6>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid mt--6">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-soft border-0">
                <div class="card-body">
                    {% if absensi_hari_ini.jam_pulang %}
                        <div class="alert alert-success alert-dismissible fade show border-0 shadow-sm" role="alert">
                            <span class="alert-icon"><i class="ni ni-like-2"></i></span>
                            <span class="alert-text"><strong>Selesai!</strong> Anda sudah melakukan absen pulang hari ini. Sampai jumpa besok!</span>
                            <hr class="my-3">
                            <p class="mb-0">
                                Waktu absen masuk: <strong>{{ absensi_hari_ini.jam_masuk|time:"H:i:s" }}</strong><br>
                                Waktu absen pulang: <strong>{{ absensi_hari_ini.jam_pulang|time:"H:i:s" }}</strong><br>
                                Alamat Pulang: <strong>{{ absensi_hari_ini.alamat_pulang|default:"-" }}</strong>
                            </p>
                        </div>
                    {% else %}
                        <!-- 3 Info Cards Row -->
                        <div class="row mb-4">
                            <div class="col-4">
                                <div class="rounded p-3 text-center" style="background: #1368A3;">
                                    <i class="ni ni-watch-time text-white mb-2" style="font-size: 1.25rem;"></i>
                                    <p class="text-white-50 text-xs mb-1">Waktu</p>
                                    <h4 id="liveClock" class="text-white mb-0 font-weight-bold">--:--:--</h4>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="rounded p-3 text-center" style="background: #1368A3;">
                                    <i class="ni ni-time-alarm text-white mb-2" style="font-size: 1.25rem;"></i>
                                    <p class="text-white-50 text-xs mb-1">Jam Masuk</p>
                                    <h4 class="text-white mb-0 font-weight-bold">{{ absensi_hari_ini.jam_masuk|time:'H:i' }}</h4>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="rounded p-3 text-center" style="background: #1368A3;">
                                    <i class="ni ni-calendar-grid-58 text-white mb-2" style="font-size: 1.25rem;"></i>
                                    <p class="text-white-50 text-xs mb-1">Tanggal</p>
                                    <h4 class="text-white mb-0 font-weight-bold">{% now 'd M' %}</h4>
                                </div>
                            </div>
                        </div>

                        <!-- Location & Submit Row -->
                        <div class="row align-items-center">
                            <div class="col-lg-6 mb-3 mb-lg-0">
                                <h6 class="text-muted mb-3"><i class="fas fa-map-marked-alt mr-2"></i> Status Lokasi</h6>
                                
                                <div id="locationCard" class="location-card shadow-sm mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="location-icon-wrapper mr-3">
                                            <i id="locationIcon" class="fas fa-location-arrow text-warning"></i>
                                        </div>
                                        <div class="location-details">
                                            <div id="locationStatusText" class="status-main">Mendeteksi Lokasi...</div>
                                            <div id="locationSubText" class="status-sub">Sedang mengambil koordinat GPS Anda</div>
                                        </div>
                                    </div>
                                    
                                    <div id="locationCoords" class="mt-2 pt-2 border-top" style="display: none; border-color: rgba(0,0,0,0.05) !important;">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-muted small">
                                                <i class="fas fa-crosshairs mr-1"></i> 
                                                <span id="latitude">-</span>, <span id="longitude">-</span>
                                            </span>
                                            <span class="badge badge-light badge-sm text-muted" title="Akurasi GPS">
                                                Â± <span id="accuracy">-</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                {% if warning_message %}
                                <div class="alert alert-warning mb-3" role="alert">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>
                                    {{ warning_message }}
                                </div>
                                {% endif %}
                                
                                <p class="text-muted text-sm mb-2">
                                    <i class="ni ni-time-alarm mr-1"></i> Durasi kerja: <strong>{{ jam_kerja }} jam</strong>
                                </p>
                                
                                <form id="absenForm" method="post" action="{% url 'absen_pulang_magang' %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="id_karyawan" value="{{ karyawan.id }}">
                                    <input type="hidden" name="lokasi" id="hiddenLokasi" value="">
                                    <input type="hidden" name="latitude" id="hiddenLatitude">
                                    <input type="hidden" name="longitude" id="hiddenLongitude">
                                    <input type="hidden" id="isWfaData" value="{{ is_wfa|yesno:'true,false' }}">
                                    <input type="hidden" id="wfaKeteranganData" value="{{ wfa_keterangan|default:'' }}">
                                    
                                    <button type="submit" id="absenButton" class="btn btn-warning btn-lg btn-block" disabled style="border-radius: 12px;">
                                        <i class="fas fa-door-open mr-2"></i> Submit Absen Pulang
                                    </button>
                                </form>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'includes/footer.html' %}
{% endblock %}

{% block javascripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Live Clock
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('liveClock').textContent = `${hours}:${minutes}:${seconds}`;
        }
        updateClock();
        setInterval(updateClock, 1000);

        const locationCard = document.getElementById('locationCard');
        const locationIcon = document.getElementById('locationIcon');
        const locationStatusText = document.getElementById('locationStatusText');
        const locationSubText = document.getElementById('locationSubText');
        const locationCoords = document.getElementById('locationCoords');
        const latitudeEl = document.getElementById('latitude');
        const longitudeEl = document.getElementById('longitude');
        const accuracyEl = document.getElementById('accuracy');
        const hiddenLatitude = document.getElementById('hiddenLatitude');
        const hiddenLongitude = document.getElementById('hiddenLongitude');
        const absenButton = document.getElementById('absenButton');
        
        // Initialize values from hidden inputs or logic
        const isWfaFromTemplate = document.getElementById('isWfaData')?.value === 'true';
        const wfaKeterangan = document.getElementById('wfaKeteranganData')?.value || "";

        function updateLocationUI(state, title, sub, iconClass, cardClass) {
            locationStatusText.textContent = title;
            locationSubText.textContent = sub;
            locationIcon.className = iconClass;
            locationCard.className = 'location-card shadow-sm mb-3 ' + cardClass;
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const acc = position.coords.accuracy;

                        latitudeEl.textContent = lat.toFixed(6);
                        longitudeEl.textContent = lon.toFixed(6);
                        accuracyEl.textContent = acc.toFixed(1) + ' m';
                        locationCoords.style.display = 'block';

                        hiddenLatitude.value = lat;
                        hiddenLongitude.value = lon;
                        
                        const hiddenLokasi = document.getElementById('hiddenLokasi');
                        if (hiddenLokasi) hiddenLokasi.value = `${lat}, ${lon}`;

                        // Validasi geofencing via API
                        const checkUrl = "{% url 'check_location' %}";
                        fetch(`${checkUrl}?lat=${lat}&lon=${lon}`)
                            .then(response => response.json())
                            .then(data => {
                                if (isWfaFromTemplate || data.is_wfa_day) {
                                    const modeLabel = wfaKeterangan || data.wfa_keterangan || 'WFH';
                                    updateLocationUI('wfh', modeLabel, 'Presensi diizinkan dari mana saja', 'fas fa-home text-info', 'wfh');
                                    absenButton.disabled = false;
                                    absenButton.classList.remove('btn-secondary');
                                    absenButton.classList.add('btn-warning');
                                } else if (data.is_within_geofence) {
                                    updateLocationUI('valid', 'Lokasi Valid', 'Anda berada di area ' + (data.office_name || 'ASEEC'), 'fas fa-check-circle text-success', 'valid');
                                    absenButton.disabled = false;
                                    absenButton.classList.remove('btn-secondary');
                                    absenButton.classList.add('btn-warning');
                                } else {
                                    updateLocationUI('invalid', 'Di Luar Radius', data.message || 'Silakan menuju ke lokasi kantor', 'fas fa-times-circle text-danger', 'invalid');
                                    absenButton.disabled = true;
                                    absenButton.classList.add('btn-secondary');
                                    absenButton.classList.remove('btn-warning');
                                }
                            })
                            .catch(error => {
                                console.error('Error checking location:', error);
                                updateLocationUI('error', 'Gagal Validasi', 'Koneksi bermasalah saat mengecek lokasi', 'fas fa-exclamation-triangle text-warning', 'invalid');
                            });
                    },
                    function(error) {
                        let msg = "Gagal mengambil GPS";
                        let detail = "Izin lokasi dibatasi";
                        switch(error.code) {
                            case error.PERMISSION_DENIED: detail = "Klik gembok di address bar untuk mengaktifkan"; break;
                            case error.POSITION_UNAVAILABLE: detail = "Sinyal GPS tidak terdeteksi"; break;
                            case error.TIMEOUT: detail = "Permintaan waktu habis"; break;
                        }
                        updateLocationUI('error', msg, detail, 'fas fa-exclamation-triangle text-danger', 'invalid');
                        locationStatusText.innerHTML += ` <button type="button" class="btn btn-sm btn-link p-0 ml-1 text-primary" onclick="location.reload()">Coba Lagi</button>`;
                    },
                    { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 }
                );
            } else {
                updateLocationUI('error', 'Browser Tidak Support', 'Geolocation tidak tersedia di browser ini', 'fas fa-bug text-danger', 'invalid');
            }
        }

        getLocation();
    });
</script>

<style>
    .location-card {
        border-radius: 12px;
        padding: 16px;
        background: #fff;
        border: 1px solid rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }
    .location-card.valid { border-left: 5px solid #2dce89; background: #f6fdf9; }
    .location-card.wfh { border-left: 5px solid #11cdef; background: #f0faff; }
    .location-card.invalid { border-left: 5px solid #f5365c; background: #fffcfc; }
    
    .location-icon-wrapper {
        width: 42px;
        height: 42px;
        border-radius: 10px;
        background: rgba(0,0,0,0.03);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }
    .valid .location-icon-wrapper { background: rgba(45, 206, 137, 0.1); }
    .wfh .location-icon-wrapper { background: rgba(17, 205, 239, 0.1); }
    .invalid .location-icon-wrapper { background: rgba(245, 54, 92, 0.1); }

    .status-main { font-weight: 700; font-size: 1rem; color: #32325d; margin-bottom: 2px; }
    .status-sub { font-size: 0.85rem; color: #8898aa; }

    .shadow-soft {
        box-shadow: 0 0.75rem 1.5rem rgba(18, 38, 63, 0.03) !important;
    }
    .animate-pulse {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(251, 99, 64, 0.7); }
        70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(251, 99, 64, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(251, 99, 64, 0); }
    }
</style>
{% endblock %}
